<?php

/**
 * Zikula Application Framework
 *
 * @copyright (c) 2002, Zikula Development Team
 * @link http://www.zikula.org
 * @license GNU/GPL - http://www.gnu.org/copyleft/gpl.html
 * @package Zikula_Value_Addons
 * @subpackage FAQ
 */
class FAQ_Controller_Admin extends Zikula_AbstractController
{

    public function postInitialize()
    {
        $this->view->setCaching(false);
    }

    /**
     * the main administration function
     *
     * @return       output       The main module admin page.
     */
    public function main()
    {
        $this->redirect(ModUtil::url('FAQ', 'admin', 'view'));
    }

    /**
     * form to add new faq
     *
     * @return       output       The main module admin page.
     */
    public function newfaq()
    {
        $this->throwForbiddenUnless(SecurityUtil::checkPermission('FAQ::', '::', ACCESS_ADD), LogUtil::getErrorMsgPermission());

        // Get the module vars
        $modvars = ModUtil::getVar('FAQ');

        if ($modvars['enablecategorization']) {
            $catregistry = CategoryRegistryUtil::getRegisteredModuleCategories('FAQ', 'faqanswer');
            $this->view->assign('catregistry', $catregistry);
        }

        // Return the output that has been generated by this function
        return $this->view->fetch('admin/newfaq.tpl');
    }

    /**
     * Create an faq
     *
     * @param        name         the name of the item to be created
     * @param        number       the number of the item to be created
     */
    public function create($args)
    {
        $this->checkCsrfToken();

        // Get parameters from whatever input we need
        $faq = FormUtil::getPassedValue('faq', isset($args['faq']) ? $args['faq'] : null, 'POST');

        // Create the FAQ
        $faqid = ModUtil::apiFunc('FAQ', 'admin', 'create', $faq);

        if ($faqid != false) {
            // Success
            LogUtil::registerStatus($this->__('Done! Item created.'));
            $this->view->clear_cache();
        }

        $this->redirect(ModUtil::url('FAQ', 'admin', 'view'));
    }

    /**
     * modify an faq
     *
     * @param        tid          the id of the item to be modified
     * @return       output       the modification page
     */
    public function modify($args)
    {
        $dom = ZLanguage::getModuleDomain('FAQ');
        $faqid = FormUtil::getPassedValue('faqid', isset($args['faqid']) ? $args['faqid'] : null, 'GET');
        $objectid = FormUtil::getPassedValue('objectid', isset($args['objectid']) ? $args['objectid'] : null, 'GET');

        if (!empty($objectid)) {
            $faqid = $objectid;
        }

        $this->throwForbiddenUnless(SecurityUtil::checkPermission('FAQ::', "$faqid::", ACCESS_EDIT), LogUtil::getErrorMsgPermission());

        $item = ModUtil::apiFunc('FAQ', 'user', 'get', array('faqid' => $faqid));
        if (!$item) {
            return LogUtil::registerError($this->__('No such item found.'), 404);
        }

        // Assign the item
        $this->view->assign($item);

        $categories = CategoryRegistryUtil::getRegisteredModuleCategories('FAQ', 'faqanswer');
        $this->view->assign('categories', $categories);

        // Return the output that has been generated by this function
        return $this->view->fetch('admin/modify.tpl');
    }

    /**
     * update the faq
     *
     * @param        tid          the id of the item to be modified
     * @param        name         the name of the item to be updated
     * @param        number       the number of the item to be updated
     */
    public function update($args)
    {
        $this->checkCsrfToken();

        $faq = FormUtil::getPassedValue('faq', isset($args['faq']) ? $args['faq'] : null, 'POST');
        if (!empty($faq['objectid'])) {
            $faq['faqid'] = $faq['objectid'];
        }

        // Update FAQ
        if (ModUtil::apiFunc('FAQ', 'admin', 'update', $faq)) {
            // Success
            LogUtil::registerStatus($this->__('Done! Item updated.'));
            $this->view->clear_cache();
        }

        $this->redirect(ModUtil::url('FAQ', 'admin', 'view'));
    }

    /**
     * delete an faq
     *
     * @param        tid            the id of the item to be modified
     * @param        confirmation   confirmation that this item can be deleted
     */
    public function delete($args)
    {
        $dom = ZLanguage::getModuleDomain('FAQ');

        $faqid = FormUtil::getPassedValue('faqid', isset($args['faqid']) ? $args['faqid'] : null, 'REQUEST');
        $objectid = FormUtil::getPassedValue('objectid', isset($args['objectid']) ? $args['objectid'] : null, 'REQUEST');
        $confirmation = FormUtil::getPassedValue('confirmation', null, 'POST');
        if (!empty($objectid)) {
            $faqid = $objectid;
        }

        // Get the current FAQ
        $item = ModUtil::apiFunc('FAQ', 'user', 'get', array('faqid' => $faqid));

        if (!$item) {
            return LogUtil::registerError($this->__('No such item found.'), 404);
        }

        $this->throwForbiddenUnless(SecurityUtil::checkPermission('FAQ::', "$faqid::", ACCESS_DELETE), LogUtil::getErrorMsgPermission());

        // Check for confirmation.
        if (empty($confirmation)) {
            // No confirmation yet
            // Add a hidden field for the item ID to the output
            $this->view->assign('faqid', $faqid);

            // Return the output that has been generated by this function
            return $this->view->fetch('admin/delete.tpl');
        }

        // If we get here it means that the user has confirmed the action

        $this->checkCsrfToken();

        // delete the faq
        if (ModUtil::apiFunc('FAQ', 'admin', 'delete', array('faqid' => $faqid))) {
            // Success
            LogUtil::registerStatus($this->__('Done! Item deleted.'));
            $this->view->clear_cache();
        }

        $this->redirect(ModUtil::url('FAQ', 'admin', 'view'));
    }

    /**
     * view items
     *
     * This function shows all items and lists the administration
     * options.
     *
     * @param        startnum     The number of the first item to show
     * @return       output       The main module admin page
     */
    public function view($args)
    {
        $this->throwForbiddenUnless(SecurityUtil::checkPermission('FAQ::', '::', ACCESS_EDIT), LogUtil::getErrorMsgPermission());

        $startnum = FormUtil::getPassedValue('startnum', isset($args['startnum']) ? $args['startnum'] : null, 'GET');
        $property = FormUtil::getPassedValue('faq_property', isset($args['faq_property']) ? $args['faq_property'] : null, 'POST');
        $category = FormUtil::getPassedValue("faq_{$property}_category", isset($args["faq_{$property}_category"]) ? $args["faq_{$property}_category"] : null, 'POST');
        $clear = FormUtil::getPassedValue('clear', false, 'POST');
        $purge = FormUtil::getPassedValue('purge', false, 'GET');

        if ($purge) {
            if (ModUtil::apiFunc('FAQ', 'admin', 'purgepermalinks')) {
                LogUtil::registerStatus($this->__('Purging of the pemalinks was successful'));
            } else {
                LogUtil::registerError($this->__('Purging of the pemalinks has failed'));
            }
            return System::redirect(strpos(System::serverGetVar('HTTP_REFERER'), 'purge') ? ModUtil::url('FAQ', 'admin', 'view') : System::serverGetVar('HTTP_REFERER'));
        }
        if ($clear) {
            $property = null;
            $category = null;
        }

        // get module vars for later use
        $modvars = ModUtil::getVar('FAQ');

        if ($modvars['enablecategorization']) {
            $catregistry = CategoryRegistryUtil::getRegisteredModuleCategories('FAQ', 'faqanswer');
            $properties = array_keys($catregistry);

            // Validate and build the category filter - mateo
            if (!empty($property) && in_array($property, $properties) && !empty($category)) {
                $catFilter = array($property => $category);
            }

            // Assign a default property - mateo
            if (empty($property) || !in_array($property, $properties)) {
                $property = $properties[0];
            }

            // plan ahead for ML features
            $propArray = array();
            foreach ($properties as $prop) {
                $propArray[$prop] = $prop;
            }
        }

        // get all faq's
        $items = ModUtil::apiFunc('FAQ', 'user', 'getall', array('startnum' => $startnum,
                    'numitems' => $modvars['itemsperpage'],
                    'category' => isset($catFilter) ? $catFilter : null,
                    'catregistry' => isset($catregistry) ? $catregistry : null));

        foreach ($items as $key => $item) {
            $options = array();
            if (SecurityUtil::checkPermission('FAQ::', "$item[faqid]::", ACCESS_EDIT)) {
                $options[] = array('url' => ModUtil::url('FAQ', 'admin', 'modify', array('faqid' => $item['faqid'])),
                    'image' => 'xedit.png',
                    'title' => $this->__('Edit'));
                if (SecurityUtil::checkPermission('FAQ::', "$item[faqid]::", ACCESS_DELETE)) {
                    $options[] = array('url' => ModUtil::url('FAQ', 'admin', 'delete', array('faqid' => $item['faqid'])),
                        'image' => '14_layer_deletelayer.png',
                        'title' => $this->__('Delete'));
                }
            }

            // Add the calculated menu options to the item array
            $items[$key]['options'] = $options;
        }

        // Assign the items and modvars to the template
        $this->view->assign('faqs', $items);

        // Assign the default language
        $this->view->assign('lang', ZLanguage::getLanguageCode());

        // Assign the categories information if enabled
        if ($modvars['enablecategorization']) {
            $this->view->assign('catregistry', $catregistry);
            $this->view->assign('numproperties', count($propArray));
            $this->view->assign('properties', $propArray);
            $this->view->assign('property', $property);
            $this->view->assign("category", $category);
        }

        // assign the values for the smarty plugin to produce a pager
        $this->view->assign('pager', array('numitems' => ModUtil::apiFunc('FAQ', 'user', 'countitems', array('category' => isset($catFilter) ? $catFilter : null)),
            'itemsperpage' => $modvars['itemsperpage']));

        // Return the output that has been generated by this function
        return $this->view->fetch('admin/view.tpl');
    }

    /**
     * Modify configuration
     *
     * This is a standard function to modify the configuration parameters of the
     * module
     *
     * @return       output       The configuration page
     */
    public function modifyconfig()
    {
        $this->throwForbiddenUnless(SecurityUtil::checkPermission('FAQ::', '::', ACCESS_ADMIN), LogUtil::getErrorMsgPermission());

        return $this->view->fetch('admin/modifyconfig.tpl');
    }

    /**
     * Update the configuration
     *
     * This is a standard function to update the configuration parameters of the
     * module given the information passed back by the modification form
     * Modify configuration
     *
     * @param        itemsperpage   number of items per page
     */
    public function updateconfig()
    {
        $this->throwForbiddenUnless(SecurityUtil::checkPermission('FAQ::', '::', ACCESS_ADMIN), LogUtil::getErrorMsgPermission());

        $this->checkCsrfToken();

        // Update module variables
        $vars['itemsperpage'] = FormUtil::getPassedValue('itemsperpage', 25, 'POST');
        $vars['enablecategorization'] = (bool)FormUtil::getPassedValue('enablecategorization', false, 'POST');
        $vars['addcategorytitletopermalink'] = (bool)FormUtil::getPassedValue('addcategorytitletopermalink', false, 'POST');

        $this->setVars($vars);

        // The configuration has been changed, so we clear all caches for this module.
        $this->view->clear_cache();

        // the module configuration has been updated successfuly
        LogUtil::registerStatus($this->__('Done! Module configuration updated.'));

        $this->redirect(ModUtil::url('FAQ', 'admin', 'view'));
    }

}